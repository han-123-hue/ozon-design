<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Magnet Studio Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        :root { --gold: #d4af37; --dark: #0a0a0a; --glass: rgba(255, 255, 255, 0.05); }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: var(--dark); color: white; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* ÁéªÁíÉÊãüÊÄÅ UI */
        .glass-panel { background: var(--glass); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; }
        
        .header { padding: 20px; text-align: center; border-bottom: 1px solid #222; }
        .header h1 { margin: 0; font-size: 18px; letter-spacing: 2px; color: var(--gold); }
        .ai-status { font-size: 10px; color: #00ff00; text-transform: uppercase; margin-top: 5px; }

        .canvas-area { flex: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        #magnet-stage { width: 320px; height: 320px; background: #fff; position: relative; overflow: hidden; border-radius: 15px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        #tpl-layer { position: absolute; inset: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        #user-photo { position: absolute; top: 50%; left: 50%; width: 160px; z-index: 5; touch-action: none; transform: translate(-50%, -50%); display: none; }

        /* Êô∫ËÉΩÂØπËØùÊ°Ü */
        #ai-bubble { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 80%; padding: 10px; font-size: 12px; text-align: center; color: var(--gold); display: none; z-index: 100; }

        .footer { padding: 20px; background: #111; border-top-left-radius: 30px; border-top-right-radius: 30px; }
        .tpl-scroll { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 20px; }
        .tpl-btn { width: 60px; height: 60px; border-radius: 10px; border: 2px solid transparent; flex-shrink: 0; filter: grayscale(1); }
        .tpl-btn.active { border-color: var(--gold); filter: grayscale(0); transform: scale(1.1); }

        .btn-action { background: linear-gradient(45deg, #d4af37, #f4d03f); color: black; padding: 18px; border-radius: 15px; text-align: center; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 14px; }
        #loading { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="loading">üöÄ AI –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï... (AIËøûÊé•‰∏≠)</div>

<div class="header">
    <h1>AI MAGNET STUDIO</h1>
    <div class="ai-status">‚óè Gemini 1.5 Flash Active</div>
</div>

<div class="canvas-area">
    <div id="ai-bubble" class="glass-panel">ÂàÜÊûê‰∏≠...</div>
    <div id="magnet-stage">
        <img id="tpl-layer" src="https://img.alicdn.com/imgextra/i4/2210667046465/O1CN01Zp1X1X1X1X1X1X1X1X_!!2210667046465.jpg">
        <img id="user-photo">
    </div>
</div>

<div class="footer glass-panel">
    <div class="tpl-scroll" id="tplList">
        <img class="tpl-btn active" src="https://img.alicdn.com/imgextra/i4/2210667046465/O1CN01Zp1X1X1X1X1X1X1X1X_!!2210667046465.jpg" onclick="selectTpl(this)">
        <img class="tpl-btn" src="https://img.alicdn.com/imgextra/i2/2210667046465/O1CN016pXv1r1X1X1X1X1X1X_!!2210667046465.jpg" onclick="selectTpl(this)">
    </div>

    <label class="btn-action">
        ‚ú® –ó–ê–ì–†–£–ó–ò–¢–¨ –ò –°–û–ó–î–ê–¢–¨
        <input type="file" id="fileIn" style="display:none" accept="image/*">
    </label>
    <div style="text-align:center; margin-top:15px; font-size:10px; color:#555;">POWERED BY GEMINI AI LAB</div>
</div>

<script>
    // --- ÊÅ©‰∫∫ÔºåËøôÈáåÂ°´‰Ω†ÁöÑÂèåÂØÜÈí• ---
    const REMOVE_BG_KEY = 'd12kqQkrNx9hZgF6ZRU8MSmA';
    const GEMINI_KEY = 'AIzaSyAQ6gZ0QkTy51DFNEJ-JqdDcsqhzm2j7KQ';

    let scale = 1, angle = 0, x = 0, y = 0;
    const photo = document.getElementById('user-photo');

    function selectTpl(el) {
        document.getElementById('tpl-layer').src = el.src;
        document.querySelectorAll('.tpl-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
    }

    document.getElementById('fileIn').onchange = async (e) => {
        const file = e.target.files[0];
        if(!file) return;
        
        document.getElementById('loading').style.display = 'flex';
        
        // 1. ÂêåÊó∂ËøõË°åÔºöAI Êä†Âõæ Âíå Gemini Êô∫ËÉΩÂàÜÊûê
        const base64 = await toBase64(file);
        
        try {
            const [bgResult, aiSuggestion] = await Promise.all([
                removeBackground(file),
                askGeminiDesigner(base64.split(',')[1])
            ]);

            // Â∫îÁî®Êä†Âõæ
            photo.src = URL.createObjectURL(bgResult);
            photo.style.display = 'block';

            // Â∫îÁî® Gemini Âª∫ËÆÆ
            showAIBubble(aiSuggestion);
            
        } catch (err) {
            alert("–û—à–∏–±–∫–∞ —Å–∏—Å—Ç–µ–º—ã AI. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    };

    // Gemini ËÆæËÆ°ÊÄªÁõëÈÄªËæë
    async function askGeminiDesigner(base64) {
        const prompt = "Analyze this photo for a custom magnet. Who is in the photo? (Person/Pet/Group). Suggest one short, warm Russian greeting (3-5 words) for a gift. Return ONLY a JSON like: {'type':'...', 'msg':'...'}";
        
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
            method: 'POST',
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inline_data: { mime_type: "image/jpeg", data: base64 } }] }] })
        });
        const data = await res.json();
        return JSON.parse(data.candidates[0].content.parts[0].text.replace(/```json|```/g, ''));
    }

    async function removeBackground(file) {
        const fd = new FormData();
        fd.append('image_file', file);
        const res = await fetch('https://api.remove.bg/v1.0/removebg', {
            method: 'POST',
            headers: {'X-Api-Key': REMOVE_BG_KEY},
            body: fd
        });
        return res.blob();
    }

    function showAIBubble(data) {
        const bubble = document.getElementById('ai-bubble');
        bubble.innerHTML = `ü§ñ AI –°–æ–≤–µ—Ç: "${data.msg}"<br><small>(–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º —Å—Ç–∏–ª—å: ${data.type})</small>`;
        bubble.style.display = 'block';
    }

    function toBase64(file) {
        return new Promise((res) => {
            const r = new FileReader();
            r.onload = () => res(r.result);
            r.readAsDataURL(file);
        });
    }

    // ‰∫§‰∫íÈÄªËæë
    interact('#user-photo').gesturable({
        onmove: (ev) => {
            scale *= (1 + ev.ds);
            angle += ev.da;
            updateStyle();
        }
    }).draggable({
        onmove: (ev) => {
            x += ev.dx; y += ev.dy;
            updateStyle();
        }
    });

    function updateStyle() {
        photo.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px)) scale(${scale}) rotate(${angle}deg)`;
    }
</script>
</body>
</html>
